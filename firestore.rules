rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helpers ──────────────────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    // Read the caller's profile from /users/{uid} (cached per request)
    function userData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // True if caller's user doc has farmId matching this farm
    function isFarmMember(farmId) {
      return isAuthenticated() && userData().farmId == farmId;
    }

    // True if caller belongs to this farm AND has one of the listed roles
    function hasRole(farmId, roles) {
      return isFarmMember(farmId) && userData().role in roles;
    }

    // ── ACCESS CONTROL ──────────────────────────────────────────────────
    // Approved user: email must be in the farm's approvedEmails allowlist.
    // Falls back to open access if config doc or approvedEmails field
    // doesn't exist yet (bootstrapping / demo farms).
    function isApprovedUser(farmId) {
      return isAuthenticated() && (
        !exists(/databases/$(database)/documents/farms/$(farmId)/meta/config) ||
        !('approvedEmails' in get(/databases/$(database)/documents/farms/$(farmId)/meta/config).data) ||
        request.auth.token.email in get(/databases/$(database)/documents/farms/$(farmId)/meta/config).data.approvedEmails
      );
    }

    // ── User profile docs ───────────────────────────────────────────────
    // Any authenticated user can read (needed for auth boot flow).
    // Users can write their own doc. Admins can write any user.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      allow write: if isAuthenticated() && userData().role == 'admin';
    }

    // ── Collection group: invites ───────────────────────────────────────
    match /{path=**}/invites/{inviteId} {
      allow read: if isAuthenticated()
                  && resource.data.email == request.auth.token.email;
    }

    // ── Farm-level data ─────────────────────────────────────────────────
    match /farms/{farmId} {

      // Farm root doc: approved users only
      allow read: if isApprovedUser(farmId);

      // ── Config doc: any auth user can READ (needed for access check). ─
      // Only approved admins can WRITE.
      match /meta/config {
        allow read:  if isAuthenticated();
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['admin']);
      }

      // ── Default: approved reads, role-gated writes ────────────────────
      match /{document=**} {
        allow read:  if isApprovedUser(farmId);
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['admin', 'manager']);
      }

      // ── Employee write access (production data) ───────────────────────
      match /batches/{batchId} {
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['employee']);
      }
      match /activities/{activityId} {
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['employee']);
      }

      // ── Driver write access ───────────────────────────────────────────
      match /deliveries/{deliveryId} {
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['driver']);
      }

      // ── Chef / customer access ────────────────────────────────────────
      match /customers/{customerId} {
        allow write: if isApprovedUser(farmId) && isOwner(customerId);
      }
      match /customers/{customerId}/fcmTokens/{tokenId} {
        allow write: if isApprovedUser(farmId) && isOwner(customerId);
      }
      match /orders/{orderId} {
        allow create: if isApprovedUser(farmId)
                      && request.resource.data.customerId == request.auth.uid;
      }

      // ── Invites: admin + manager can manage ───────────────────────────
      match /invites/{inviteId} {
        allow write: if isApprovedUser(farmId) && hasRole(farmId, ['admin', 'manager']);
      }

      // ── Learning Engine — read-only (writes via Admin SDK only) ───────
      match /stats/{document=**} {
        allow write: if false;
      }
      match /alerts/{alertId} {
        allow write: if false;
      }
    }

    // ── Everything else: deny by default (Firestore default) ────────────
  }
}
